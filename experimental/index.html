<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Lista de Trocas do Tony</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">Lista de Trocas do Tony</h1>
  
  <div class="grid grid-cols-2 gap-8">
    <!-- Selling/Trading -->
    <div>
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">Tenho</h2>
      </div>
      <input id="selling-search" type="text" placeholder="Pesquisar..." class="w-full mb-2 border p-1 rounded text-sm">
      <div class="flex justify-between items-center mb-2">
        <div>
          <label class="mr-1">Ordenar por:</label>
          <select id="selling-sort" class="border rounded p-1 text-sm">
            <option value="random">Aleatório</option>
            <option value="name">Nome</option>
            <option value="setid">Número</option>
            <option value="passcode">Código</option>
            <option value="price">Preço</option>
            <option value="quantity">Quantidade</option>
          </select>
          <button id="selling-order" class="ml-1 bg-gray-200 px-2 rounded text-sm">Ascendente</button>
        </div>
      </div>
      <div id="selling-list" class="grid gap-4 h-[70vh] overflow-y-auto"></div>
    </div>
    
    <!-- Looking For -->
    <div>
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">Quero</h2>
      </div>
      <input id="wanted-search" type="text" placeholder="Pesquisar..." class="w-full mb-2 border p-1 rounded text-sm">
      <div class="flex justify-between items-center mb-2">
        <div>
          <label class="mr-1">Ordenar por:</label>
          <select id="wanted-sort" class="border rounded p-1 text-sm">
            <option value="random">Aleatório</option>
            <option value="name">Nome</option>
            <option value="setid">Número</option>
            <option value="passcode">Código</option>
            <option value="price">Preço</option>
            <option value="quantity">Quantidade</option>
          </select>
          <button id="wanted-order" class="ml-1 bg-gray-200 px-2 rounded text-sm">Ascendente</button>
        </div>
      </div>
      <div id="wanted-list" class="grid gap-4 h-[70vh] overflow-y-auto"></div>
    </div>
  </div>

  <!-- Popup Modal -->
  <div id="popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div id="popup-content" class="bg-white rounded-xl shadow-lg p-6 max-w-lg w-full relative">
      <button id="popup-close" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-2xl">&times;</button>
      <div id="popup-body"></div>
    </div>
  </div>

  <script>
    const sellingList = document.getElementById("selling-list");
    const wantedList = document.getElementById("wanted-list");

    const sellingSortSelect = document.getElementById("selling-sort");
    const sellingOrderBtn = document.getElementById("selling-order");
    const wantedSortSelect = document.getElementById("wanted-sort");
    const wantedOrderBtn = document.getElementById("wanted-order");

    const sellingSearch = document.getElementById("selling-search");
    const wantedSearch = document.getElementById("wanted-search");

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpJVCUhWxyH_TM4-83ra9FXLCES8yqIBVQy3ed6OoVZwbSH4LkoVh7gBn6K2iz32cQNftsj1E-UIiK/pub?output=csv";

    let sellingCards = [];
    let wantedCards = [];

    // Modal logic
    const popupOverlay = document.getElementById('popup-overlay');
    const popupContent = document.getElementById('popup-content');
    const popupBody = document.getElementById('popup-body');
    const popupClose = document.getElementById('popup-close');
    popupClose.addEventListener('click', () => {
      popupOverlay.classList.add('hidden');
      popupBody.innerHTML = '';
    });
    popupOverlay.addEventListener('click', (e) => {
      if (e.target === popupOverlay) {
        popupOverlay.classList.add('hidden');
        popupBody.innerHTML = '';
      }
    });

    async function loadCsv(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: false,
          skipEmptyLines: true,
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    // Fetch Portuguese card info from Yugipedia only when requested
    async function fetchYugipediaCardInfo(ptName) {
      const searchUrl = `https://yugipedia.com/api.php?action=query&format=json&list=search&srsearch=${encodeURIComponent(ptName)}&utf8=1&srlimit=1`;
      try {
        const searchRes = await fetch(searchUrl);
        const searchData = await searchRes.json();
        const result = searchData?.query?.search?.[0];
        if (!result) return { description: "Descrição não encontrada.", image: "" };

        const pageId = result.pageid;
        const pageUrl = `https://yugipedia.com/api.php?action=query&format=json&prop=extracts|pageimages&exintro=1&explaintext=1&pithumbsize=400&pageids=${pageId}`;
        const pageRes = await fetch(pageUrl);
        const pageData = await pageRes.json();
        const page = pageData.query.pages[pageId];

        const description = page.extract || "Descrição não encontrada.";
        const image = page.original?.source || page.thumbnail?.source || "";

        return { description, image };
      } catch (err) {
        return { description: "Descrição não encontrada.", image: "" };
      }
    }

    function createCardElementYugipedia(card, type) {
      // type is either "selling" or "wanted"
      if (!card.name?.trim()) return null;

      // Prefer custom image if present, else blank
      let image = card.customImage?.trim() || "";

      const cardEl = document.createElement("div");
      cardEl.className = "bg-white rounded-xl shadow-md p-3 flex gap-3 items-center cursor-pointer hover:ring-2 hover:ring-blue-400 transition";
      cardEl.innerHTML = `
        <img src="${image || ''}" alt="${card.name}" class="w-20 h-28 object-cover rounded bg-gray-200">
        <div>
          <h4 class="font-bold">${card.name}</h4>
          ${card.setid?.trim() ? `<p class="text-sm text-gray-600">Número: ${card.setid}</p>` : ""}
          ${card.price?.trim() ? `<p class="text-sm text-green-600">R$ ${card.price}</p>` : ""}
          ${card.quantity?.trim() ? `<p class="text-sm text-blue-600">Quantidade: ${card.quantity}</p>` : ""}
        </div>
      `;
      cardEl.addEventListener('click', async () => {
        // Show popup and load description
        popupOverlay.classList.remove('hidden');
        popupBody.innerHTML = `
          <div class="flex gap-4 items-start">
            <img src="${image || ''}" alt="${card.name}" class="w-32 h-44 object-cover rounded bg-gray-200 flex-shrink-0">
            <div>
              <h2 class="text-xl font-bold mb-2">${card.name}</h2>
              ${card.setid?.trim() ? `<p class="text-sm text-gray-600 mb-1">Número: ${card.setid}</p>` : ""}
              ${card.price?.trim() ? `<p class="text-sm text-green-600 mb-1">R$ ${card.price}</p>` : ""}
              ${card.quantity?.trim() ? `<p class="text-sm text-blue-600 mb-1">Quantidade: ${card.quantity}</p>` : ""}
              <div id="popup-desc" class="mt-2 text-gray-700 italic">Carregando descrição...</div>
            </div>
          </div>
        `;
        // Fetch Yugipedia info
        const info = await fetchYugipediaCardInfo(card.name);
        const descBox = document.getElementById('popup-desc');
        descBox.textContent = info.description;
        if (!image && info.image) {
          // If there was no image before, update it
          popupBody.querySelector('img').src = info.image;
        }
      });
      return cardEl;
    }

    function renderListYugipedia(listEl, cards, searchTerm = "") {
      listEl.innerHTML = "";
      const term = searchTerm.toLowerCase();
      cards.forEach(card => {
        const matches = Object.values(card).some(value => (value || "").toLowerCase().includes(term));
        if (matches) {
          const el = createCardElementYugipedia(card);
          if (el) listEl.appendChild(el);
        }
      });
    }

    function sortCards(cards, key, ascending=true) {
      if (key === "random") {
        return cards.sort(() => Math.random() - 0.5);
      }
      return cards.sort((a, b) => {
        let valA = a[key]?.trim() || "";
        let valB = b[key]?.trim() || "";
        if (key === "price" || key === "passcode" || key === "quantity") {
          valA = parseFloat(valA) || 0;
          valB = parseFloat(valB) || 0;
        }
        if (valA < valB) return ascending ? -1 : 1;
        if (valA > valB) return ascending ? 1 : -1;
        return 0;
      });
    }

    async function renderCardsYugipedia() {
      const rows = await loadCsv(csvUrl);
      if (rows.length === 0) return;

      const headers = rows[0].map(h => h.trim().toLowerCase());
      const getIndex = name => headers.indexOf(name.toLowerCase());
      const map = {
        sellingName: getIndex("selling name"),
        sellingSetID: getIndex("selling set id"),
        sellingPasscode: getIndex("selling passcode"),
        sellingPrice: getIndex("selling price"),
        sellingImage: getIndex("selling image url"),
        sellingQuantity: getIndex("selling quantity"),

        wantedName: getIndex("wanted name"),
        wantedSetID: getIndex("wanted set id"),
        wantedPasscode: getIndex("wanted passcode"),
        wantedPrice: getIndex("wanted price"),
        wantedImage: getIndex("wanted image url"),
        wantedQuantity: getIndex("wanted quantity")
      };

      sellingCards = [];
      wantedCards = [];

      rows.slice(1).forEach(cols => {
        sellingCards.push({
          name: map.sellingName >= 0 ? cols[map.sellingName] : "",
          setid: map.sellingSetID >= 0 ? cols[map.sellingSetID] : "",
          passcode: map.sellingPasscode >= 0 ? cols[map.sellingPasscode] : "",
          price: map.sellingPrice >= 0 ? cols[map.sellingPrice] : "",
          customImage: map.sellingImage >= 0 ? cols[map.sellingImage] : "",
          quantity: map.sellingQuantity >= 0 ? cols[map.sellingQuantity] : ""
        });
        wantedCards.push({
          name: map.wantedName >= 0 ? cols[map.wantedName] : "",
          setid: map.wantedSetID >= 0 ? cols[map.wantedSetID] : "",
          passcode: map.wantedPasscode >= 0 ? cols[map.wantedPasscode] : "",
          price: map.wantedPrice >= 0 ? cols[map.wantedPrice] : "",
          customImage: map.wantedImage >= 0 ? cols[map.wantedImage] : "",
          quantity: map.wantedQuantity >= 0 ? cols[map.wantedQuantity] : ""
        });
      });

      renderListYugipedia(sellingList, sortCards(sellingCards, "random"));
      renderListYugipedia(wantedList, sortCards(wantedCards, "random"));
    }

    function setupSortingAndSearchYugipedia() {
      // Selling
      const updateSelling = () => {
        const sorted = sortCards([...sellingCards], sellingSortSelect.value, sellingOrderBtn.textContent === "Ascendente");
        renderListYugipedia(sellingList, sorted, sellingSearch.value);
      };
      sellingSortSelect.addEventListener("change", updateSelling);
      sellingOrderBtn.addEventListener("click", () => {
        sellingOrderBtn.textContent = sellingOrderBtn.textContent === "Ascendente" ? "Descendente" : "Ascendente";
        updateSelling();
      });
      sellingSearch.addEventListener("input", updateSelling);

      // Wanted
      const updateWanted = () => {
        const sorted = sortCards([...wantedCards], wantedSortSelect.value, wantedOrderBtn.textContent === "Ascendente");
        renderListYugipedia(wantedList, sorted, wantedSearch.value);
      };
      wantedSortSelect.addEventListener("change", updateWanted);
      wantedOrderBtn.addEventListener("click", () => {
        wantedOrderBtn.textContent = wantedOrderBtn.textContent === "Ascendente" ? "Descendente" : "Ascendente";
        updateWanted();
      });
      wantedSearch.addEventListener("input", updateWanted);
    }

    renderCardsYugipedia().then(setupSortingAndSearchYugipedia);
  </script>
</body>
</html>
