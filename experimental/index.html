<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpJVCUhWxyH_TM4-83ra9FXLCES8yqIBVQy3ed6OoVZwbSH4LkoVh7gBn6K2iz32cQNftsj1E-UIiK/pub?output=csv";

let sellingCards = [];
let wantedCards = [];

// ---------- Helpers ----------
async function loadCsv(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

function createCardElement(card) {
  if (!card.name) return null;

  let image = card.passcode
    ? `https://images.ygoprodeck.com/images/cards/${card.passcode.replace(/^0+/, "")}.jpg`
    : "";
  if (card.customImage) image = card.customImage;

  const div = document.createElement("div");
  div.className = "bg-white rounded-xl shadow-md p-3 flex gap-3 items-center";

  div.innerHTML = `
    <img src="${image}" alt="${card.name}" class="w-20 h-[86px] aspect-[86/59] object-contain rounded cursor-pointer">
    <div>
      <h4 class="font-bold">${card.name}</h4>
      ${card.setid ? `<p class="text-sm text-gray-600">Número: ${card.setid}</p>` : ""}
      ${card.passcode ? `<p class="text-sm text-gray-600">Código: ${card.passcode}</p>` : ""}
      ${card.price ? `<p class="text-sm text-green-600">R$ ${card.price}</p>` : ""}
      ${card.quantity ? `<p class="text-sm text-blue-600">Quantidade: ${card.quantity}</p>` : ""}
    </div>
  `;

  // Only the image triggers the modal now
  const imgEl = div.querySelector("img");
  imgEl.addEventListener("click", () => showCardModal(card));

  return div;
}

// Locale-aware sorting
function sortCards(cards, key, ascending = true) {
  if (key === "random") return [...cards].sort(() => Math.random() - 0.5);
  return [...cards].sort((a, b) => {
    let valA = a[key] || "";
    let valB = b[key] || "";

    if (["price", "passcode", "quantity"].includes(key)) {
      valA = parseFloat(valA) || 0;
      valB = parseFloat(valB) || 0;
    } else {
      valA = valA.toString();
      valB = valB.toString();
      // localeCompare ensures correct accent handling
      return ascending
        ? valA.localeCompare(valB, 'pt-BR', { sensitivity: 'base' })
        : valB.localeCompare(valA, 'pt-BR', { sensitivity: 'base' });
    }

    return ascending ? (valA > valB ? 1 : valA < valB ? -1 : 0) : (valA < valB ? 1 : valA > valB ? -1 : 0);
  });
}

// ---------- Card info modal ----------
async function fetchCardDetails(passcode) {
  if (!passcode) return null;
  const code = passcode.replace(/^0+/, "");

  async function fetchWithLang(lang) {
    try {
      const res = await fetch(`https://db.ygoprodeck.com/api/v7/cardinfo.php?id=${code}&language=${lang}`);
      if (!res.ok) return null;
      const data = await res.json();
      if (data.error) return null;
      return data?.data?.[0] || null;
    } catch { return null; }
  }

  let details = await fetchWithLang("pt");
  if (!details) details = await fetchWithLang("en");
  return details;
}

async function showCardModal(card) {
  const modal = document.getElementById("card-modal");
  const modalContent = document.getElementById("modal-content");
  modal.classList.remove("hidden");
  modalContent.innerHTML = "<p>Carregando...</p>";

  const details = await fetchCardDetails(card.passcode);

  if (details) {
    modalContent.innerHTML = `
      <button id="modal-close" class="absolute top-2 right-2 text-red-600 text-2xl font-bold hover:text-red-800">&times;</button>
      <h2 class="text-xl font-bold mb-2">${details.name}</h2>
      <img src="${details.card_images?.[0]?.image_url || card.customImage || `https://images.ygoprodeck.com/images/cards/${card.passcode?.replace(/^0+/, "")}.jpg`}" alt="${details.name}" class="w-40 h-56 object-contain mb-4 rounded">
      <p><strong>Tipo:</strong> ${details.type}</p>
      <p><strong>Level/Rank:</strong> ${details.level || details.rank || "N/A"}</p>
      <p><strong>Ataque:</strong> ${details.atk ?? "N/A"}</p>
      <p><strong>Defesa:</strong> ${details.def ?? "N/A"}</p>
      <p><strong>Descrição:</strong> ${details.desc}</p>
      <a href="https://ygoprodeck.com/card/?search=${details.id}" target="_blank" class="text-blue-600 underline">Mais informações</a>
    `;

    const closeBtn = document.getElementById("modal-close");
    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      modalContent.innerHTML = "";
    });

    // Close modal on outside click
    modal.addEventListener("click", e => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        modalContent.innerHTML = "";
      }
    });

    // Close modal on ESC
    document.addEventListener("keydown", function escListener(e) {
      if (e.key === "Escape") {
        modal.classList.add("hidden");
        modalContent.innerHTML = "";
        document.removeEventListener("keydown", escListener);
      }
    });
  } else {
    modalContent.innerHTML = `
      <button id="modal-close" class="absolute top-2 right-2 text-red-600 text-2xl font-bold hover:text-red-800">&times;</button>
      <h2 class="text-xl font-bold mb-2">${card.name}</h2>
      <img src="${card.customImage || `https://images.ygoprodeck.com/images/cards/${card.passcode?.replace(/^0+/, "")}.jpg`}" alt="${card.name}" class="w-40 h-56 object-contain mb-4 rounded">
      <p>Informações detalhadas não encontradas.</p>
    `;
    const closeBtn = document.getElementById("modal-close");
    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      modalContent.innerHTML = "";
    });

    modal.addEventListener("click", e => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        modalContent.innerHTML = "";
      }
    });

    document.addEventListener("keydown", function escListener(e) {
      if (e.key === "Escape") {
        modal.classList.add("hidden");
        modalContent.innerHTML = "";
        document.removeEventListener("keydown", escListener);
      }
    });
  }
}

// ---------- Rendering ----------
function renderSection({cards, listEl, searchInput, sortSelect, orderBtn}) {
  function update() {
    const search = searchInput.value.toLowerCase();
    const sorted = sortCards(cards, sortSelect.value, orderBtn.textContent === "Ascendente");
    listEl.innerHTML = "";
    sorted.forEach(card => {
      const values = Object.values(card).join(" ").toLowerCase();
      if (values.includes(search)) {
        const el = createCardElement(card);
        if (el) listEl.appendChild(el);
      }
    });
  }
  sortSelect.addEventListener("change", update);
  orderBtn.addEventListener("click", () => {
    orderBtn.textContent = orderBtn.textContent === "Ascendente" ? "Descendente" : "Ascendente";
    update();
  });
  searchInput.addEventListener("input", update);
  update(); // initial
}

// ---------- Init ----------
document.getElementById("modal-close").addEventListener("click", () => {
  const modal = document.getElementById("card-modal");
  modal.classList.add("hidden");
  document.getElementById("modal-content").innerHTML = "";
});

(async function init() {
  const rows = await loadCsv(csvUrl);
  if (!rows.length) return;

  const normalizedRows = rows.map(r => {
    const obj = {};
    for (const key in r) {
      const norm = key.trim().toLowerCase().replace(/\s+/g, "");
      obj[norm] = r[key];
    }
    return obj;
  });

  sellingCards = normalizedRows.map(r => ({
    name: r["sellingname"] || "",
    setid: r["sellingsetid"] || "",
    passcode: r["sellingpasscode"] || "",
    price: r["sellingprice"] || "",
    customImage: r["sellingimageurl"] || "",
    quantity: r["sellingquantity"] || ""
  })).filter(c => c.name);

  wantedCards = normalizedRows.map(r => ({
    name: r["wantedname"] || "",
    setid: r["wantedsetid"] || "",
    passcode: r["wantedpasscode"] || "",
    price: r["wantedprice"] || "",
    customImage: r["wantedimageurl"] || "",
    quantity: r["wantedquantity"] || ""
  })).filter(c => c.name);

  const options = [
    {value: "random", label: "Aleatório"},
    {value: "name", label: "Nome"},
    {value: "setid", label: "Número"},
    {value: "passcode", label: "Código"},
    {value: "price", label: "Preço"},
    {value: "quantity", label: "Quantidade"}
  ];
  ["selling-sort", "wanted-sort"].forEach(id => {
    const select = document.getElementById(id);
    select.innerHTML = "";
    options.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o.value;
      opt.textContent = o.label;
      select.appendChild(opt);
    });
  });

  renderSection({
    cards: sellingCards,
    listEl: document.getElementById("selling-list"),
    searchInput: document.getElementById("selling-search"),
    sortSelect: document.getElementById("selling-sort"),
    orderBtn: document.getElementById("selling-order")
  });

  renderSection({
    cards: wantedCards,
    listEl: document.getElementById("wanted-list"),
    searchInput: document.getElementById("wanted-search"),
    sortSelect: document.getElementById("wanted-sort"),
    orderBtn: document.getElementById("wanted-order")
  });
})();
</script>
