let selectAllCheckbox = null; // for the "Select All" toggle

function renderSection({cards, listEl, searchInput, sortSelect, orderBtn, withSelection = false}) {
  function update() {
    const search = searchInput.value.toLowerCase();
    const sorted = sortCards(cards, sortSelect.value, orderBtn.textContent === "Ascendente");
    listEl.innerHTML = "";

    let hasResults = false;
    sorted.forEach(card => {
      const values = Object.values(card).join(" ").toLowerCase();
      if (values.includes(search)) {
        const el = createCardElement(card, withSelection);
        if (el) {
          listEl.appendChild(el);
          hasResults = true;
        }
      }
    });

    if (!hasResults) {
      listEl.innerHTML = `<p class="text-gray-500 italic text-center">Ops! Nada para ver aqui...</p>`;
    }

    if (withSelection) {
      const checkboxes = listEl.querySelectorAll(".card-checkbox");
      const qtyInputs = listEl.querySelectorAll(".quantity-input");

      checkboxes.forEach(cb => {
        cb.addEventListener("change", e => {
          const passcode = e.target.dataset.passcode;
          const qtyInput = listEl.querySelector(`.quantity-input[data-passcode='${passcode}']`);
          if (e.target.checked) {
            selectedSelling[passcode] = parseInt(qtyInput.value) || 1;
          } else {
            delete selectedSelling[passcode];
          }
          updateSellingTotal();
          updateSelectAllCheckbox();
        });
      });

      qtyInputs.forEach(inp => {
        inp.addEventListener("input", e => {
          const passcode = e.target.dataset.passcode;
          let val = parseInt(e.target.value) || 1;
          if (val < 1) val = 1;
          if (val > parseInt(e.target.max)) val = parseInt(e.target.max);
          e.target.value = val;
          if (selectedSelling[passcode] !== undefined) {
            selectedSelling[passcode] = val;
            updateSellingTotal();
          }
        });
      });
    }
  }

  sortSelect.addEventListener("change", update);
  orderBtn.addEventListener("click", () => {
    orderBtn.textContent = orderBtn.textContent === "Ascendente" ? "Descendente" : "Ascendente";
    update();
  });
  searchInput.addEventListener("input", update);
  update();
}

function updateSelectAllCheckbox() {
  const allCheckboxes = document.querySelectorAll("#selling-list .card-checkbox:not(:disabled)");
  const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
  if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
}

// ---------------- Copy List ----------------
function generateSellingListText() {
  let output = [];
  const cardCountMap = {}; // for detecting multiple IDs per card

  // count how many cards share the same name
  sellingCards.forEach(c => {
    if (!cardCountMap[c.name]) cardCountMap[c.name] = [];
    if (selectedSelling[c.passcode]) cardCountMap[c.name].push(c.passcode);
  });

  for (const [passcode, qty] of Object.entries(selectedSelling)) {
    const card = sellingCards.find(c => c.passcode === passcode);
    if (card) {
      let line = `${qty} ${card.name}`;
      // only add setid if there are multiple different passcodes for same name
      if (cardCountMap[card.name].length > 1 && card.setid) {
        const trimmedSetId = card.setid.split("-")[0]; // QoL trim before "-"
        line += ` (${trimmedSetId})`;
      }
      output.push(line);
    }
  }
  return output.join("\n");
}

// ---------------- Init ----------------
(async function init() {
  const rows = await loadCsv(csvUrl);
  if (!rows.length) return;

  const normalizedRows = rows.map(r => {
    const obj = {};
    for (const key in r) obj[key.trim().toLowerCase().replace(/\s+/g, "")] = r[key];
    return obj;
  });

  sellingCards = normalizedRows.map(r => ({
    name: r["sellingname"] || "",
    setid: r["sellingsetid"] || "",
    passcode: r["sellingpasscode"] || "",
    price: r["sellingprice"] || "",
    customImage: r["sellingimageurl"] || "",
    quantity: r["sellingquantity"] || ""
  })).filter(c => c.name);

  wantedCards = normalizedRows.map(r => ({
    name: r["wantedname"] || "",
    setid: r["wantedsetid"] || "",
    passcode: r["wantedpasscode"] || "",
    price: r["wantedprice"] || "",
    customImage: r["wantedimageurl"] || "",
    quantity: r["wantedquantity"] || ""
  })).filter(c => c.name);

  const options = [
    {value: "random", label: "Aleatório"},
    {value: "name", label: "Nome"},
    {value: "setid", label: "Número"},
    {value: "passcode", label: "Código"},
    {value: "price", label: "Preço"},
    {value: "quantity", label: "Quantidade"}
  ];
  ["selling-sort", "wanted-sort"].forEach(id => {
    const select = document.getElementById(id);
    select.innerHTML = "";
    options.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o.value;
      opt.textContent = o.label;
      select.appendChild(opt);
    });
  });

  renderSection({
    cards: sellingCards,
    listEl: document.getElementById("selling-list"),
    searchInput: document.getElementById("selling-search"),
    sortSelect: document.getElementById("selling-sort"),
    orderBtn: document.getElementById("selling-order"),
    withSelection: true
  });

  renderSection({
    cards: wantedCards,
    listEl: document.getElementById("wanted-list"),
    searchInput: document.getElementById("wanted-search"),
    sortSelect: document.getElementById("wanted-sort"),
    orderBtn: document.getElementById("wanted-order")
  });

  // ---------------- Select All Checkbox ----------------
  const selectAllContainer = document.getElementById("select-all-selling");
  // convert the button into a checkbox with label
  selectAllContainer.outerHTML = `<label class="flex items-center gap-2"><input type="checkbox" id="select-all-checkbox"> Selecionar Todos</label>`;
  selectAllCheckbox = document.getElementById("select-all-checkbox");

  selectAllCheckbox.addEventListener("change", () => {
    selectedSelling = {};
    const allCheckboxes = document.querySelectorAll("#selling-list .card-checkbox:not(:disabled)");
    allCheckboxes.forEach(cb => {
      cb.checked = selectAllCheckbox.checked;
      const qtyInput = document.querySelector(`.quantity-input[data-passcode='${cb.dataset.passcode}']`);
      if (selectAllCheckbox.checked) {
        qtyInput.value = qtyInput.max;
        selectedSelling[cb.dataset.passcode] = parseInt(qtyInput.max) || 1;
      }
    });
    updateSellingTotal();
  });

  document.getElementById("copy-selling").addEventListener("click", () => {
    const text = generateSellingListText();
    navigator.clipboard.writeText(text).then(() => alert("Lista copiada!"));
  });
})();
  </script>
</body>
</html>
