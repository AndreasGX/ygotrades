<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Lista de Trocas do Tony</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
  .out-of-stock img {
    filter: contrast(50%);
  }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">Lista de Trocas do Tony</h1>
  <p class="text-center text-gray-600 mb-6">Minha página para venda e troca de cards de Yu-Gi-Oh! Aqui você encontra os que tenho disponíveis para troca e também os que estou procurando.</p>

  <div id="warnings" class="max-w-3xl mx-auto mb-6 text-red-600 font-semibold"></div>
  <div class="grid grid-cols-2 gap-8">
    <!-- Selling/Trading -->
    <div>
      <h2 class="text-xl font-semibold mb-2">Tenho</h2>
      <input id="selling-search" type="text" placeholder="Pesquisar..." class="w-full mb-2 border p-1 rounded text-sm">
      <div class="flex items-center gap-4 mb-2">
        <label>Ordenar por:</label>
        <select id="selling-sort" class="border rounded p-1 text-sm"></select>
        <button id="selling-order" class="bg-gray-200 px-2 rounded text-sm">Ascendente</button>
        <label class="flex items-center gap-2 ml-auto">
          <input type="checkbox" id="select-all-selling" class="h-4 w-4">
          Selecionar tudo
        </label>
      </div>
      <div id="selling-list" class="grid gap-4 h-[70vh] overflow-y-auto mb-4"></div>
      <div class="flex items-center gap-4">
        <p id="selling-total" class="font-semibold text-lg">Total: R$ 0,00</p>
        <button id="copy-selling" class="ml-auto bg-green-500 text-white px-3 py-1 rounded text-sm">Copiar Seleção</button>
      </div>
    </div>

    <!-- Looking For -->
    <div>
      <h2 class="text-xl font-semibold mb-2">Quero</h2>
      <input id="wanted-search" type="text" placeholder="Pesquisar..." class="w-full mb-2 border p-1 rounded text-sm">
      <div class="flex items-center gap-2 mb-2">
        <label>Ordenar por:</label>
        <select id="wanted-sort" class="border rounded p-1 text-sm"></select>
        <button id="wanted-order" class="bg-gray-200 px-2 rounded text-sm">Ascendente</button>
      </div>
      <div id="wanted-list" class="grid gap-4 h-[70vh] overflow-y-auto"></div>
    </div>
  </div>

  <!-- Card Details Modal -->
<div id="card-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
  <div id="modal-content" class="bg-white rounded-xl shadow-lg w-full max-w-[700px] aspect-[59/43] flex overflow-hidden relative">
    <!-- Close Button -->
    <button id="modal-close" class="absolute top-3 right-3 text-red-600 text-2xl font-bold hover:text-red-800">&times;</button>

    <!-- Left: Card Image -->
    <div class="h-[400px] flex-none flex items-center justify-center bg-gray-100 p-4">
      <img id="modal-card-image" src="" alt="" class="object-contain h-full rounded">
    </div>

    <!-- Right: Info -->
    <div class="flex-1 p-4 overflow-y-auto flex flex-col" id="modal-card-info">
      <h2 class="text-2xl font-bold mb-4" id="modal-card-name"></h2>
      <div id="modal-card-details" class="flex-1">
        <p>Carregando...</p>
      </div>
      <a href="#" target="_blank" class="text-blue-600 underline mt-4 inline-block" id="modal-card-link">Mais Informações</a>
    </div>
  </div>
</div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpJVCUhWxyH_TM4-83ra9FXLCES8yqIBVQy3ed6OoVZwbSH4LkoVh7gBn6K2iz32cQNftsj1E-UIiK/pub?output=csv";

    let sellingCards = [];
    let wantedCards = [];
    let selectedSelling = {};
    let currentSellingOrder = [];

    async function loadCsv(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    function formatPrice(value) {
      const num = parseFloat((value || "").toString().replace(',', '.'));
      if (isNaN(num)) return "";
      return num.toFixed(2).replace('.', ',');
    }

    function createCardElement(card, index, withSelection = false) {
      if (!card.name) return null;
      let image = "";
      if (card.customImage) {
        image = card.customImage;
      } else if (card.passcode) {
        const code = card.passcode.replace(/^0+/, "");
        image = `https://images.ygoprodeck.com/images/cards/${code}.jpg`;
      }

      const div = document.createElement("div");
      div.className = "bg-white rounded-xl shadow-md p-3 flex gap-3 items-center";

      const qtyNum = parseInt(card.quantity, 10);
      const isOutOfStock = Number.isFinite(qtyNum) ? qtyNum === 0 : false;
      if (isOutOfStock) div.classList.add("out-of-stock");

      let checkboxHtml = "";
      let quantityHtml = "";
      if (withSelection && !isOutOfStock) {
        checkboxHtml = `<input type="checkbox" class="card-checkbox" data-index="${index}">`;
        const maxAttr = Math.max(1, qtyNum || 1);
        quantityHtml = `<input type="number" min="1" max="${maxAttr}" value="1" class="quantity-input border rounded w-16 p-1 mt-1 text-sm" data-index="${index}">`;
      }

      let quantityDisplay = "";
      if (card.quantity !== undefined && card.quantity !== "") {
        quantityDisplay = `<p class="text-sm text-blue-600">Qtd: ${card.quantity}</p>`;
      }

      let outOfStockBadge = "";
      if (isOutOfStock) {
        outOfStockBadge = `<p class="text-sm text-red-500 font-semibold">Esgotado</p>`;
      }

      div.innerHTML = `
        ${checkboxHtml}
        <img src="${image}" alt="${card.name}" class="w-20 h-[86px] object-contain rounded cursor-pointer">
        <div>
          <h4 class="font-bold">${card.name}</h4>
          ${card.setid ? `<p class="text-sm text-gray-600">Número: ${card.setid}</p>` : ""}
          ${card.passcode ? `<p class="text-sm text-gray-600">Código: ${card.passcode}</p>` : ""}
          ${card.price ? `<p class="text-sm text-green-600">R$ ${formatPrice(card.price)}</p>` : ""}
          ${quantityDisplay}
          ${outOfStockBadge}
          ${quantityHtml}
        </div>
      `;

      div.querySelector("img")?.addEventListener("click", e => {
        e.stopPropagation();
        showCardModal(card);
      });

      return div;
    }

    function updateSellingTotal() {
      let total = 0;
      for (const [key, qty] of Object.entries(selectedSelling)) {
        const idx = parseInt(key, 10);
        const card = sellingCards[idx];
        if (!card) continue;
        const rawPrice = (card.price || "").toString().replace(',', '.');
        const priceNum = parseFloat(rawPrice) || 0;
        total += priceNum * (Number(qty) || 0);
      }
      document.getElementById("selling-total").textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    function generateSellingListText() {
      let output = [];
      currentSellingOrder.forEach(idx => {
        const card = sellingCards[idx];
        if (!card) return;
        if (!selectedSelling[idx]) return;
        const qty = selectedSelling[idx];
        let line = `${qty} ${card.name}`;
        if (card.setid) {
          const trimmedSet = card.setid.split("-")[0];
          line += ` (${trimmedSet})`;
        }
        output.push(line);
      });
      return output.join("\n");
    }

    function renderSection({cards, listEl, searchInput, sortSelect, orderBtn, withSelection = false}) {
      function update() {
        const search = searchInput.value.toLowerCase();
        const sortedIndices = sortCards(cards, sortSelect.value, orderBtn.textContent === "Ascendente");
        listEl.innerHTML = "";
        let hasResults = false;
        const visibleIndices = [];
        sortedIndices.forEach(index => {
          const card = cards[index];
          const values = Object.values(card).join(" ").toLowerCase();
          if (values.includes(search)) {
            const el = createCardElement(card, index, withSelection);
            if (el) {
              listEl.appendChild(el);
              hasResults = true;
              visibleIndices.push(index);
            }
          }
        });
        if (!hasResults) {
          listEl.innerHTML = `<p class="text-gray-500 italic text-center">Ops! Nada para ver aqui...</p>`;
        }
        if (withSelection) {
          currentSellingOrder = visibleIndices;
          listEl.querySelectorAll('.card-checkbox').forEach(cb => {
            cb.addEventListener('change', e => {
              const idx = e.target.dataset.index;
              const qtyInput = listEl.querySelector(`.quantity-input[data-index='${idx}']`);
              if (e.target.checked) {
                selectedSelling[idx] = parseInt(qtyInput?.value || 1, 10) || 1;
              } else {
                delete selectedSelling[idx];
              }
              updateSellingTotal();
            });
          });
          listEl.querySelectorAll('.quantity-input').forEach(inp => {
            inp.addEventListener('input', e => {
              const idx = e.target.dataset.index;
              const val = parseInt(e.target.value, 10) || 1;
              if (selectedSelling[idx] !== undefined) {
                selectedSelling[idx] = val;
                updateSellingTotal();
              }
            });
          });
        }
      }
      sortSelect.addEventListener("change", update);
      orderBtn.addEventListener("click", () => {
        orderBtn.textContent = orderBtn.textContent === "Ascendente" ? "Descendente" : "Ascendente";
        update();
      });
      searchInput.addEventListener("input", update);
      update();
    }

    function sortCards(cards, key, ascending = true) {
      const indices = cards.map((_, i) => i);
      if (key === 'random') return indices.sort(() => Math.random() - 0.5);
      indices.sort((i, j) => {
        let valA = cards[i][key] || "";
        let valB = cards[j][key] || "";
        if (key === 'name') {
          return (valA).toString().localeCompare(valB.toString(), 'pt', { sensitivity: 'base' }) * (ascending ? 1 : -1);
        }
        if (["price", "passcode", "quantity"].includes(key)) {
          const aNum = parseFloat((valA || '').toString().replace(',', '.')) || 0;
          const bNum = parseFloat((valB || '').toString().replace(',', '.')) || 0;
          return ascending ? (aNum - bNum) : (bNum - aNum);
        }
        return ascending ? ('' + valA).localeCompare('' + valB, 'pt', { sensitivity: 'base' }) : ('' + valB).localeCompare('' + valA, 'pt', { sensitivity: 'base' });
      });
      return indices;
    }

    async function fetchCardDetails(passcode) {
      if (!passcode) return null;
      const code = passcode.replace(/^0+/, "");
      try {
        const res = await fetch(`https://db.ygoprodeck.com/api/v7/cardinfo.php?id=${code}&language=pt`);
        if (!res.ok) return null;
        const data = await res.json();
        if (data.error || !data.data?.length) return null;
        return data.data[0];
      } catch {
        return null;
      }
    }

    async function showCardModal(card) {
  const modal = document.getElementById("card-modal");
  const imgEl = document.getElementById("modal-card-image");
  const nameEl = document.getElementById("modal-card-name");
  const detailsEl = document.getElementById("modal-card-details");
  const linkEl = document.getElementById("modal-card-link");

  modal.classList.remove("hidden");

  // Set basic info immediately
  imgEl.src = card.customImage ? card.customImage : `https://images.ygoprodeck.com/images/cards/${card.passcode.replace(/^0+/, "")}.jpg`;
  imgEl.alt = card.name;
  nameEl.textContent = card.name;
  detailsEl.innerHTML = "<p>Carregando...</p>";

  const moreInfoUrl = card.passcode ? `https://ygoprodeck.com/card/?search=${card.passcode.replace(/^0+/, "")}` : "#";
  linkEl.href = moreInfoUrl;

  const details = await fetchCardDetails(card.passcode);

  if (details) {
    detailsEl.innerHTML = `
      <p><strong>Tipo:</strong> ${details.type}</p>
      <p><strong>Level/Rank:</strong> ${details.level || details.rank || "N/A"}</p>
      <p><strong>Ataque:</strong> ${details.atk ?? "N/A"}</p>
      <p><strong>Defesa:</strong> ${details.def ?? "N/A"}</p>
      <p><strong>Descrição:</strong> ${details.desc}</p>
    `;
  } else {
    detailsEl.innerHTML = `<p>Informações detalhadas não encontradas.</p>`;
  }
}
    
    const modal = document.getElementById("card-modal");
    document.getElementById("modal-close").addEventListener("click", () => modal.classList.add("hidden"));
    modal.addEventListener("click", e => { if (e.target === modal) modal.classList.add("hidden"); });
    document.addEventListener("keydown", e => { if (e.key === "Escape") modal.classList.add("hidden"); });


    (async function init() {
      const rows = await loadCsv(csvUrl);
      if (!rows.length) return;

      sellingCards = rows.map(r => ({
        name: r["sellingname"] || "",
        setid: r["sellingsetid"] || "",
        passcode: r["sellingpasscode"] || "",
        price: r["sellingprice"] || "",
        customImage: r["sellingimageurl"] || "",
        quantity: r["sellingquantity"] || ""
      })).filter(c => c.name);

      wantedCards = rows.map(r => ({
        name: r["wantedname"] || "",
        setid: r["wantedsetid"] || "",
        passcode: r["wantedpasscode"] || "",
        price: r["wantedprice"] || "",
        customImage: r["wantedimageurl"] || "",
        quantity: r["wantedquantity"] || ""
      })).filter(c => c.name);

      // ---------- Warnings ----------
      function checkWarnings() {
        const warnings = [];
        const sellingMap = new Map();
        const wantedMap = new Map();

        // Check duplicates in selling
        sellingCards.forEach(c => {
          const key = `${c.passcode}|${c.setid}`;
          if (sellingMap.has(key)) warnings.push(`Duplicado em "Tenho": ${c.name} (${c.setid})`);
          sellingMap.set(key, true);
        });

        // Check duplicates in wanted
        wantedCards.forEach(c => {
          const key = `${c.passcode}`;
          if (wantedMap.has(key)) warnings.push(`Duplicado em "Quero": ${c.name}`);
          wantedMap.set(key, true);
        });

        // Check same passcode + Set-ID in both lists
        const sellingKeys = new Set(sellingCards.map(c => `${c.passcode}`));
        wantedCards.forEach(c => {
          const key = `${c.passcode}`;
          if (sellingKeys.has(key)) warnings.push(`${c.name} aparece em "Tenho" e "Quero"`);
        });

        document.getElementById("warnings").innerHTML = warnings.length
          ? warnings.map(w => `<p>⚠️ ${w}</p>`).join("")
          : "";
      }

      // ---------- Init ----------
      const options = [
        {value: "random", label: "Aleatório"},
        {value: "name", label: "Nome"},
        {value: "setid", label: "Número"},
        {value: "passcode", label: "Código"},
        {value: "price", label: "Preço"},
        {value: "quantity", label: "Quantidade"}
      ];
      ["selling-sort", "wanted-sort"].forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = "";
        options.forEach(o => {
          const opt = document.createElement("option");
          opt.value = o.value;
          opt.textContent = o.label;
          select.appendChild(opt);
        });
      });

      renderSection({
        cards: sellingCards,
        listEl: document.getElementById("selling-list"),
        searchInput: document.getElementById("selling-search"),
        sortSelect: document.getElementById("selling-sort"),
        orderBtn: document.getElementById("selling-order"),
        withSelection: true
      });

      renderSection({
        cards: wantedCards,
        listEl: document.getElementById("wanted-list"),
        searchInput: document.getElementById("wanted-search"),
        sortSelect: document.getElementById("wanted-sort"),
        orderBtn: document.getElementById("wanted-order")
      });

      // Run warnings
      checkWarnings();

      document.getElementById("select-all-selling").checked = false;
      document.getElementById("select-all-selling").addEventListener("change", e => {
        const checkAll = e.target.checked;
        selectedSelling = {};
  
        document.querySelectorAll("#selling-list .card-checkbox").forEach(cb => {
          cb.checked = checkAll;
          const idx = cb.dataset.index;
          const qtyInput = document.querySelector(`.quantity-input[data-index='${idx}']`);
          if (checkAll && qtyInput) {
            // Set to the maximum quantity
            qtyInput.value = qtyInput.max || 1;
            selectedSelling[idx] = parseInt(qtyInput.value, 10);
          }
        });

  updateSellingTotal();
});

      document.getElementById("copy-selling").addEventListener("click", () => {
        const text = generateSellingListText();
        navigator.clipboard.writeText(text).then(() => {
          alert("Lista copiada!");
        });
      });

    })();
  </script>
</body>
</html>
