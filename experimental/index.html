<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpJVCUhWxyH_TM4-83ra9FXLCES8yqIBVQy3ed6OoVZwbSH4LkoVh7gBn6K2iz32cQNftsj1E-UIiK/pub?output=csv";

  const modal = document.getElementById("card-modal");
  const modalContent = document.getElementById("modal-content");
  const modalClose = document.getElementById("modal-close");
  modalClose.addEventListener("click", () => {
    modal.classList.add("hidden");
    modalContent.innerHTML = "";
  });

  const cardCache = new Map(); // cache card details

  async function loadCsv(url) {
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: results => resolve(results.data),
        error: err => reject(err)
      });
    });
  }

  function createCardElement(card) {
    if (!card.name?.trim()) return null;
    const passcode = card.passcode?.trim().replace(/^0+/, "");
    const image = card.customImage?.trim() || (passcode ? `https://images.ygoprodeck.com/images/cards/${passcode}.jpg` : "");

    const el = document.createElement("div");
    el.className = "bg-white rounded-xl shadow-md p-3 flex gap-3 items-center cursor-pointer";
    el.innerHTML = `
      <img src="${image}" alt="${card.name}" class="w-20 h-28 object-cover rounded">
      <div>
        <h4 class="font-bold">${card.name}</h4>
        ${card.setid ? `<p class="text-sm text-gray-600">Número: ${card.setid}</p>` : ""}
        ${card.passcode ? `<p class="text-sm text-gray-600">Código: ${card.passcode}</p>` : ""}
        ${card.price ? `<p class="text-sm text-green-600">R$ ${card.price}</p>` : ""}
        ${card.quantity ? `<p class="text-sm text-blue-600">Quantidade: ${card.quantity}</p>` : ""}
      </div>
    `;
    return el;
  }

  async function fetchCardDetails(passcode) {
    if (!passcode) return null;
    if (cardCache.has(passcode)) return cardCache.get(passcode);

    try {
      const trimmed = passcode.replace(/^0+/, "");
      const res = await fetch(`https://db.ygoprodeck.com/api/v7/cardinfo.php?id=${trimmed}`);
      if (!res.ok) throw new Error("Card not found");
      const data = (await res.json()).data[0];
      cardCache.set(passcode, data);
      return data;
    } catch {
      return null;
    }
  }

  async function showCardModal(card) {
    modal.classList.remove("hidden");
    modalContent.innerHTML = "<p>Carregando...</p>";

    const details = await fetchCardDetails(card.passcode);
    if (details) {
      modalContent.innerHTML = `
        <h2 class="text-xl font-bold mb-2">${details.name}</h2>
        <img src="${details.card_images[0].image_url}" alt="${details.name}" class="w-40 h-56 object-cover mb-4 rounded">
        <p><strong>Tipo:</strong> ${details.type}</p>
        <p><strong>Level/Rank:</strong> ${details.level || details.rank || "N/A"}</p>
        <p><strong>Ataque:</strong> ${details.atk ?? "N/A"}</p>
        <p><strong>Defesa:</strong> ${details.def ?? "N/A"}</p>
        <p><strong>Descrição:</strong> ${details.desc}</p>
        <a href="https://ygoprodeck.com/card/?search=${encodeURIComponent(details.name)}" target="_blank" class="text-blue-600 underline">Mais informações</a>
      `;
    } else {
      modalContent.innerHTML = `
        <h2 class="text-xl font-bold mb-2">${card.name}</h2>
        <img src="${card.customImage || `https://images.ygoprodeck.com/images/cards/${card.passcode?.replace(/^0+/, "")}.jpg`}" 
             alt="${card.name}" class="w-40 h-56 object-cover mb-4 rounded">
        <p>Informações detalhadas não encontradas.</p>
      `;
    }
  }

  function sortCards(cards, key, ascending = true) {
    if (key === "random") return [...cards].sort(() => Math.random() - 0.5);

    return [...cards].sort((a, b) => {
      let valA = a[key]?.trim() || "";
      let valB = b[key]?.trim() || "";
      if (["price", "passcode", "quantity"].includes(key)) {
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
      }
      return ascending ? valA > valB ? 1 : -1 : valA < valB ? 1 : -1;
    });
  }

  function renderList({ listEl, cards, search, sortKey, ascending }) {
    const term = search.toLowerCase();
    const filtered = cards.filter(c =>
      Object.values(c).some(v => (v || "").toLowerCase().includes(term))
    );
    const sorted = sortCards(filtered, sortKey, ascending);

    listEl.innerHTML = "";
    sorted.forEach(card => {
      const el = createCardElement(card);
      if (el) {
        el.addEventListener("click", () => showCardModal(card));
        listEl.appendChild(el);
      }
    });
  }

  function setupSection({ listEl, searchEl, sortEl, orderBtn, cards }) {
    let sortKey = "random";
    let ascending = true;

    const update = () => {
      renderList({ listEl, cards, search: searchEl.value, sortKey, ascending });
    };

    sortEl.addEventListener("change", e => {
      sortKey = e.target.value;
      update();
    });

    orderBtn.addEventListener("click", () => {
      ascending = !ascending;
      orderBtn.textContent = ascending ? "Ascendente" : "Descendente";
      update();
    });

    searchEl.addEventListener("input", update);
    update(); // initial render
  }

  async function init() {
    const rows = await loadCsv(csvUrl);
    if (!rows.length) return;

    const sellingCards = rows.map(r => ({
      name: r["selling name"] || "",
      setid: r["selling set id"] || "",
      passcode: r["selling passcode"] || "",
      price: r["selling price"] || "",
      customImage: r["selling image url"] || "",
      quantity: r["selling quantity"] || ""
    }));

    const wantedCards = rows.map(r => ({
      name: r["wanted name"] || "",
      setid: r["wanted set id"] || "",
      passcode: r["wanted passcode"] || "",
      price: r["wanted price"] || "",
      customImage: r["wanted image url"] || "",
      quantity: r["wanted quantity"] || ""
    }));

    setupSection({
      listEl: document.getElementById("selling-list"),
      searchEl: document.getElementById("selling-search"),
      sortEl: document.getElementById("selling-sort"),
      orderBtn: document.getElementById("selling-order"),
      cards: sellingCards
    });

    setupSection({
      listEl: document.getElementById("wanted-list"),
      searchEl: document.getElementById("wanted-search"),
      sortEl: document.getElementById("wanted-sort"),
      orderBtn: document.getElementById("wanted-order"),
      cards: wantedCards
    });
  }

  init();
</script>
